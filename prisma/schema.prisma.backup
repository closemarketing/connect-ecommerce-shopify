// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

// Note that some adapters may set a maximum length for the String type by default, please ensure your strings are long
// enough when changing adapters.
// See https://www.prisma.io/docs/orm/reference/prisma-schema-reference#string for more information
datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model Shop {
  id        Int      @id @default(autoincrement())
  domain    String   @unique // integra-clientify.myshopify.com
  active    Boolean  @default(true) // Si la app está instalada y activa
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sessions    Session[]
  orders      Order[]
  syncLogs    SyncLog[]
  webhookLogs WebhookLog[]
}

model Session {
  id                  String    @id
  shop                String // Dominio de la tienda (requerido por Shopify)
  shopId              Int? // FK opcional a Shop
  state               String
  isOnline            Boolean   @default(false)
  scope               String?
  expires             DateTime?
  accessToken         String
  userId              BigInt?
  firstName           String?
  lastName            String?
  email               String?
  accountOwner        Boolean   @default(false)
  locale              String?
  collaborator        Boolean?  @default(false)
  emailVerified       Boolean?  @default(false)
  refreshToken        String?
  refreshTokenExpires DateTime?

  shopRecord Shop? @relation(fields: [shopId], references: [id], onDelete: SetNull)

  @@unique([shop, isOnline]) // Solo una sesión offline por tienda
  @@index([shop])
  @@index([shopId])
}

model Integration {
  id          Int                     @id @default(autoincrement())
  name        String                  @unique // Identificador interno: clientify, agora, etc
  displayName String // Nombre para mostrar: "Clientify CRM", "Agora ERP"
  enabled     Boolean                 @default(true) // Si la integración está disponible
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  
  credentials     IntegrationCredential[]
  syncLogs        SyncLog[]
  webhookLogs     WebhookLog[]
  jobs            Job[]
  pipelineConfigs PipelineConfig[]
}

model IntegrationCredential {
  id            Int         @id @default(autoincrement())
  sessionId     String // Identificador de la tienda (shop)
  integrationId Int
  key           String // Nombre de la credencial (ej: "apikey", "url")
  value         String // Valor de la credencial
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  integration   Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@unique([sessionId, integrationId, key])
  @@index([sessionId])
}

model Order {
  id          Int      @id @default(autoincrement())
  orderId     String   @unique // ID del pedido de Shopify
  orderNumber String // Número de pedido visible
  shopId      Int // FK a Shop
  body        String   @db.LongText // JSON completo del webhook
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  shop Shop @relation(fields: [shopId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([orderId])
}

model SyncLog {
  id            Int          @id @default(autoincrement())
  shopId        Int // FK a Shop
  integrationId Int? // FK a Integration (nullable para datos antiguos)
  syncType      SyncType // Tipo de objeto sincronizado
  shopifyId     String // ID del objeto en Shopify
  externalId    String? // ID resultante en sistema externo (antes clientifyId)
  parentOrderId String? // ID de la orden padre si esta sync pertenece a una orden
  status        SyncStatus // Estado de la sincronización
  method        String? // Método HTTP: GET, POST, PUT, DELETE, etc
  url           String?      @db.Text // URL completa de la llamada a la API
  queryParams   String?      @db.Text // JSON de parámetros query si aplica
  errorMessage  String?      @db.Text // Mensaje de error si aplica
  requestData   String?      @db.LongText // JSON del request (opcional)
  responseData  String?      @db.LongText // JSON del response (opcional)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  shop        Shop         @relation(fields: [shopId], references: [id], onDelete: Cascade)
  integration Integration? @relation(fields: [integrationId], references: [id], onDelete: SetNull)

  @@index([shopId])
  @@index([integrationId])
  @@index([syncType])
  @@index([status])
  @@index([createdAt])
  @@index([parentOrderId])
}

enum SyncType {
  CUSTOMER
  PRODUCT
  DEAL
  ORDER
  PIPELINE
  STAGE
}

enum SyncStatus {
  SUCCESS
  ERROR
}

model WebhookLog {
  id            Int          @id @default(autoincrement())
  shopId        Int // FK a Shop
  integrationId Int? // FK a Integration (qué integración procesó/procesará)
  topic         String // Ej: "orders/create", "orders/updated"
  shopifyId     String? // ID del objeto en Shopify (extraído del payload)
  headers       String       @db.Text // JSON de headers relevantes
  payload       String       @db.LongText // JSON completo del webhook
  hmacValid     Boolean? // Si se validó el HMAC
  processed     Boolean      @default(false) // Si se procesó exitosamente
  errorMessage  String?      @db.Text // Error si hubo al procesar
  createdAt     DateTime     @default(now())

  shop        Shop         @relation(fields: [shopId], references: [id], onDelete: Cascade)
  integration Integration? @relation(fields: [integrationId], references: [id], onDelete: SetNull)

  @@index([shopId])
  @@index([integrationId])
  @@index([topic])Int         @id @default(autoincrement())
  shopId               Int // FK a Shop
  integrationId        Int // FK a Integration
  externalPipelineId   String // ID del pipeline en sistema externo
  externalPipelineName String // Nombre del pipeline
  isDefault            Boolean     @default(false) // Si es el pipeline por defecto
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt

  integration   Integration         @relation(fields: [integrationId], references: [id], onDelete: Cascade)
  stageMappings OrderStageMapping[]

  @@unique([shopId, integrationId, externalPipelineId])
  @@index([shopId])
  @@index([integration         DateTime @default(now())
  updatedAt             DateTime @updatedAt

  stageMappings OrderStageMapping[]

  @@unique([shopId, clientifyPipelineId])
  @@index([shopId])
}      @id @default(autoincrement())
  pipelineConfigId   Int // FK a PipelineConfig
  shopifyOrderStatus String // Estado de Shopify: pending, authorized, partially_paid, paid, partially_refunded, refunded, voided
  externalStageId    String // ID del stage en sistema externo
  externalStageName  String // Nombre del stage
  createdAt          DateTime       @default(now())
  updatedAt          DateTime      D del stage en Clientify
  clientifyStageName String // Nombre del stage
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  pipelineConfig PipelineConfig @relation(fields: [pipelineConfigId], references: [id], onDelete: Cascade)

  @@unique([pipelineConfigId, shopifyOrderStatus])
  @@index([pipelineConfigId])
}
